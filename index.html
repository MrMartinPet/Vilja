<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Tabellhj√§lte</title>
  <style>
    :root{
      /* LIGHT THEME */
      --bg:#f4f7ff;
      --panel:#ffffff;
      --panel2:#f7f9ff;
      --txt:#0b1220;
      --muted:#5a6b84;
      --good:#1fb66a;
      --bad:#e33b3b;
      --accent:#2563eb;
      --shadow: 0 10px 30px rgba(15,23,42,.12);
      --radius: 18px;
      --btn: 56px;
      --gap: 12px;
      --maxw: 980px;

      /* Key contrast */
      --keyBg:#ffffff;
      --keyBorder:#d6deee;
      --keyTxt:#0b1220;

      --focus:#94b4ff;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 420px at 50% -10%, rgba(37,99,235,.18), transparent 60%),
        radial-gradient(900px 600px at 0% 120%, rgba(31,182,106,.10), transparent 60%),
        var(--bg);
      color:var(--txt);
      min-height:100vh;
      display:flex;
      justify-content:center;
    }

    .app{
      width:100%;
      max-width:var(--maxw);
      padding:16px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.2px;
      flex-wrap:wrap;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background: rgba(37,99,235,.06);
      border:1px solid rgba(37,99,235,.16);
      padding:8px 12px;
      border-radius:999px;
      box-shadow: var(--shadow);
      user-select:none;
    }
    .chip b{ font-weight:900; }

    .btn{
      border:none;
      border-radius:999px;
      padding:10px 14px;
      background: rgba(15,23,42,.06);
      color:var(--txt);
      border:1px solid rgba(15,23,42,.12);
      cursor:pointer;
      font-weight:800;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(37,99,235,.95), rgba(37,99,235,.72));
      border:1px solid rgba(37,99,235,.35);
      color:#fff;
    }
    .btn.good{
      background: linear-gradient(180deg, rgba(31,182,106,.95), rgba(31,182,106,.72));
      border:1px solid rgba(31,182,106,.35);
      color:#fff;
    }
    .btn.danger{
      background: rgba(227,59,59,.10);
      border: 1px solid rgba(227,59,59,.25);
      color:#8a1c1c;
      font-weight:900;
    }

    .panel{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid rgba(15,23,42,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding:14px 14px 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(15,23,42,.08);
      flex-wrap:wrap;
    }
    .panel .hd .title{
      font-weight:950;
      font-size:16px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .panel .bd{
      padding:14px;
    }

    .grid{ display:grid; gap: var(--gap); }

    .grid.tables{
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
    @media (min-width: 760px){
      .grid.tables{ grid-template-columns: repeat(6, minmax(0, 1fr)); }
    }

    .card{
      background: rgba(15,23,42,.03);
      border:1px solid rgba(15,23,42,.10);
      border-radius: 16px;
      padding: 14px;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-height:60px;
    }
    .card:active{ transform: translateY(1px); }
    .card .left{ display:flex; flex-direction:column; gap:4px; }
    .card .k{ font-weight:1000; font-size:16px; line-height:1; }
    .card .s{ font-size:12px; color:var(--muted); font-weight:800; }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:34px;height:34px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.14);
      background: rgba(15,23,42,.03);
      font-size:18px;
    }

    .modes{ display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 640px){
      .modes{ grid-template-columns: 1fr 1fr; }
    }
    .modeBtn{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:16px;
      border-radius:18px;
      cursor:pointer;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.03);
    }
    .modeBtn:active{ transform: translateY(1px); }
    .modeBtn .t{ font-weight:1000; font-size:16px; }
    .modeBtn .d{ font-size:12px; color:var(--muted); margin-top:4px; font-weight:800; }
    .modeBtn .icon{
      width:42px;height:42px;
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(15,23,42,.03);
      border:1px solid rgba(15,23,42,.10);
      font-size:18px;
    }

    .gameWrap{ display:grid; gap:12px; }

    .qBox{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:16px;
      border-radius:18px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.03);
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .question{
      font-size:36px;
      font-weight:1000;
      letter-spacing:.3px;
    }
    .sub{
      color:var(--muted);
      font-size:12px;
      font-weight:900;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(15,23,42,.03);
      border:1px solid rgba(15,23,42,.10);
      font-weight:900;
    }

    /* Timer ring */
    .timerRing{
      width:46px;height:46px;
      border-radius:999px;
      display:grid;
      place-items:center;
      background:
        conic-gradient(var(--accent) var(--p, 0%), rgba(15,23,42,.10) 0);
      border:1px solid rgba(15,23,42,.12);
    }
    .timerRing span{
      font-size:12px;
      font-weight:1000;
      color:var(--txt);
    }

    /* Answer display (NO iPhone keyboard) */
    .answerRow{
      display:flex;
      gap:10px;
      align-items:stretch;
    }
    .answer{
      flex:1;
      font-size:28px;
      font-weight:1000;
      padding:14px 14px;
      border-radius:16px;
      border:2px solid rgba(15,23,42,.12);
      background: #fff;
      color:var(--txt);
      outline:none;
      text-align:center;
      letter-spacing:.5px;
      caret-color: transparent;
    }
    .answer.good{ border-color: rgba(31,182,106,.65); }
    .answer.bad{ border-color: rgba(227,59,59,.70); }
    .answer:focus{ box-shadow: 0 0 0 4px rgba(37,99,235,.18); border-color: rgba(37,99,235,.45); }

    .okBtn{
      min-width:92px;
      font-size:16px;
      font-weight:1000;
      border-radius:16px;
    }
    .okBtn:disabled{ opacity:.55; cursor:not-allowed; }

    /* Keypad: FORCE 3 columns on phone, bigger text */
    .keypad{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    .key{
      height: var(--btn);
      border-radius:16px;
      border:2px solid var(--keyBorder);
      background: var(--keyBg);
      color: var(--keyTxt);
      font-size:22px;
      font-weight:1000;
      cursor:pointer;
      text-shadow: none;
    }
    .key:active{ transform: translateY(1px); }
    .key.wide{ grid-column: span 2; }
    .key.action{
      background: rgba(37,99,235,.08);
      border-color: rgba(37,99,235,.25);
    }

    .hint{ font-size:12px; color:var(--muted); font-weight:900; }

    /* Avatar */
    .avatarLayout{ display:grid; gap:12px; }
    @media (min-width: 760px){
      .avatarLayout{ grid-template-columns: 320px 1fr; align-items:start; }
    }
    .avatarStage{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius: 22px;
      border:1px solid rgba(15,23,42,.10);
      background:
        radial-gradient(600px 400px at 50% 0%, rgba(37,99,235,.12), transparent 55%),
        rgba(15,23,42,.02);
      display:grid;
      place-items:center;
      position:relative;
      overflow:hidden;
    }

    .face{
      width:140px;height:140px;
      border-radius:40px;
      position:relative;
      border:1px solid rgba(15,23,42,.10);
      background: var(--skin, #f2c7a5);
      box-shadow: 0 12px 25px rgba(15,23,42,.12);
    }

    .hair{
      position:absolute;
      left:10px; right:10px;
      top:-8px;
      height:58px;
      border-radius: 30px 30px 26px 26px;
      background: var(--hair, #5a3b1f);
      border:1px solid rgba(15,23,42,.18);
    }
    .hair.short{ height:42px; top:-6px; }
    .hair.medium{ height:58px; }
    .hair.long{ height:78px; top:-10px; border-radius: 34px 34px 30px 30px; }
    .hair.xlong{ height:104px; top:-16px; border-radius: 38px 38px 34px 34px; }

    .eyes{
      position:absolute;
      top:56px; left:0; right:0;
      display:flex;
      justify-content:center;
      gap:22px;
    }
    .eye{
      width: var(--eyeSize, 14px);
      height: var(--eyeSize, 14px);
      border-radius:999px;
      background: var(--eye, #1f2937);
      box-shadow: inset 0 -2px 0 rgba(255,255,255,.35);
      border:1px solid rgba(15,23,42,.10);
    }

    .mouth{
      position:absolute;
      bottom:28px; left:50%;
      width:42px;height:18px;
      transform: translateX(-50%);
      border-bottom: 5px solid rgba(15,23,42,.30);
      border-radius: 0 0 999px 999px;
      opacity:.85;
    }

    .body{
      position:absolute;
      bottom:-14px; left:50%;
      transform: translateX(-50%);
      width:190px;height:130px;
      border-radius: 40px 40px 26px 26px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.03);
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding:16px;
      gap:10px;
    }
    .shirt{
      width:110px;height:70px;
      border-radius:18px;
      background: var(--top, #4da3ff);
      border:1px solid rgba(15,23,42,.12);
    }
    .pants{
      width:110px;height:34px;
      border-radius:14px;
      background: var(--bottom, #2f3a46);
      border:1px solid rgba(15,23,42,.12);
      margin-top:8px;
    }
    .shoeRow{
      display:flex;
      gap:10px;
      position:absolute;
      bottom:8px;
    }
    .shoe{
      width:46px;height:18px;border-radius:999px;
      background: var(--shoes, #eaeaea);
      border:1px solid rgba(15,23,42,.12);
    }

    .controls{ display:grid; gap:12px; }
    .control{
      border:1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.02);
      border-radius:18px;
      padding:12px;
    }
    .control .lbl{
      font-size:12px;
      color:var(--muted);
      font-weight:1000;
      margin-bottom:8px;
      letter-spacing:.2px;
    }
    .seg{ display:flex; gap:8px; flex-wrap:wrap; }
    .seg button{
      padding:10px 12px;
      border-radius:14px;
      border:2px solid rgba(15,23,42,.10);
      background: #fff;
      color:var(--txt);
      font-weight:1000;
      cursor:pointer;
    }
    .seg button.active{
      background: rgba(37,99,235,.10);
      border-color: rgba(37,99,235,.35);
    }

    .textInput{
      width:100%;
      padding:12px 14px;
      border-radius:16px;
      border:2px solid rgba(15,23,42,.12);
      background: #fff;
      color:var(--txt);
      font-size:16px;
      font-weight:900;
      outline:none;
    }
    .textInput:focus{ box-shadow: 0 0 0 4px rgba(37,99,235,.18); border-color: rgba(37,99,235,.45); }

    .stats{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .stat{
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.02);
    }
    .stat .k{ color:var(--muted); font-size:12px; font-weight:1000; }
    .stat .v{ font-size:18px; font-weight:1100; margin-top:4px; }

    .resultBig{
      font-size:32px;
      font-weight:1100;
      letter-spacing:.3px;
    }

    .confetti{
      position:fixed;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index:999;
      display:none;
    }
    .confetti.show{ display:block; }
    .confetti i{
      position:absolute;
      top:-12px;
      width:10px;height:16px;
      border-radius:3px;
      background: rgba(255,255,255,.9);
      opacity:.95;
      animation: fall 1.2s linear forwards;
      transform: rotate(var(--r, 0deg));
    }
    @keyframes fall{
      to{ transform: translateY(110vh) rotate(calc(var(--r, 0deg) + 260deg)); opacity:.0; }
    }

    .hide{ display:none !important; }
    .small{ font-size:12px; font-weight:900; color:var(--muted); }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="chip">‚öîÔ∏è <b>Tabellhj√§lte</b></div>
        <div class="chip" id="coinChip">ü™ô <b id="coins">0</b></div>
        <div class="chip">üî• <b id="streak">0</b></div>
      </div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button class="btn" id="btnHome">√ñversikt</button>
        <button class="btn" id="btnAvatar">Avatar</button>
        <button class="btn danger" id="btnReset" title="Rensa allt">Reset</button>
      </div>
    </div>

    <!-- AVATAR -->
    <section class="panel" id="screenAvatar">
      <div class="hd">
        <div class="title">üé≠ Avatar</div>
        <button class="btn primary" id="btnSaveAvatar">Spara</button>
      </div>
      <div class="bd">
        <div class="avatarLayout">
          <div>
            <div class="avatarStage">
              <div class="face" id="face" style="--skin:#f2c7a5; --hair:#5a3b1f; --top:#4da3ff; --bottom:#2f3a46; --shoes:#eaeaea; --eyeSize:14px;">
                <div class="hair medium" id="hair"></div>
                <div class="eyes" id="eyes">
                  <div class="eye"></div>
                  <div class="eye"></div>
                </div>
                <div class="mouth"></div>
              </div>
              <div class="body">
                <div>
                  <div class="shirt" id="shirt"></div>
                  <div class="pants" id="pants"></div>
                </div>
                <div class="shoeRow">
                  <div class="shoe" id="shoeL"></div>
                  <div class="shoe" id="shoeR"></div>
                </div>
              </div>
            </div>
            <div class="small" id="avatarNamePreview" style="margin-top:10px;"></div>
          </div>

          <div class="controls">
            <div class="control">
              <div class="lbl">Namn</div>
              <input class="textInput" id="inpName" placeholder="Skriv namn" autocomplete="off" />
            </div>

            <div class="control">
              <div class="lbl">Hudton</div>
              <div class="seg" id="segSkin"></div>
            </div>

            <div class="control">
              <div class="lbl">H√•r</div>
              <div class="seg" id="segHairLen"></div>
              <div style="height:10px"></div>
              <div class="seg" id="segHairCol"></div>
            </div>

            <div class="control">
              <div class="lbl">√ñgonstorlek</div>
              <div class="seg" id="segEyeSize"></div>
            </div>

            <div class="control">
              <div class="lbl">Kl√§der</div>
              <div class="small">K√∂p med ü™ô (gratis = f√∂rsta tv√•)</div>
              <div style="height:10px"></div>
              <div class="lbl">Topp</div>
              <div class="seg" id="segTop"></div>
              <div style="height:10px"></div>
              <div class="lbl">Byxa</div>
              <div class="seg" id="segBottom"></div>
              <div style="height:10px"></div>
              <div class="lbl">Skor</div>
              <div class="seg" id="segShoes"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- HOME -->
    <section class="panel hide" id="screenHome">
      <div class="hd">
        <div class="title">üß† Tabeller 0‚Äì10</div>
        <div class="small" id="homeSub"></div>
      </div>
      <div class="bd">
        <div class="grid tables" id="tablesGrid"></div>
      </div>
    </section>

    <!-- MODE -->
    <section class="panel hide" id="screenMode">
      <div class="hd">
        <div class="title" id="modeTitle">üéØ</div>
        <button class="btn" id="btnBackFromMode">Tillbaka</button>
      </div>
      <div class="bd">
        <div class="modes">
          <div class="modeBtn" id="btnPractice">
            <div>
              <div class="t">Tr√§na</div>
              <div class="d">Inga tidskrav</div>
            </div>
            <div class="icon">üéÆ</div>
          </div>
          <div class="modeBtn" id="btnSpeed">
            <div>
              <div class="t">Speed-test</div>
              <div class="d">10 sek per fr√•ga ‚Ä¢ kr√§vs f√∂r ‚≠ê</div>
            </div>
            <div class="icon">‚ö°</div>
          </div>
        </div>
      </div>
    </section>

    <!-- GAME -->
    <section class="panel hide" id="screenGame">
      <div class="hd">
        <div class="title" id="gameTitle">üéÆ</div>
        <button class="btn" id="btnQuitGame">Avsluta</button>
      </div>
      <div class="bd">
        <div class="gameWrap">
          <div class="qBox">
            <div class="row">
              <div>
                <div class="question" id="questionText">7 √ó 4</div>
                <div class="sub" id="progressText">1 / 11</div>
              </div>
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <div class="pill" title="R√§tt">‚úÖ <span id="correctCount">0</span></div>
                <div class="pill" title="Fel">‚ùå <span id="wrongCount">0</span></div>
                <div class="timerRing hide" id="timerRing" style="--p:0%;">
                  <span id="timerText">10.0</span>
                </div>
              </div>
            </div>

            <div class="answerRow">
              <!-- readonly => iPhone keyboard should NOT open -->
              <input class="answer" id="answerInput" readonly inputmode="none" autocomplete="off" placeholder="Svar" />
              <button class="btn primary okBtn" id="btnOk">OK</button>
            </div>

            <div class="hint" id="tinyHint"></div>
          </div>

          <div class="keypad" aria-label="Tangentbord">
            <button class="key" data-k="1" type="button">1</button>
            <button class="key" data-k="2" type="button">2</button>
            <button class="key" data-k="3" type="button">3</button>
            <button class="key" data-k="4" type="button">4</button>
            <button class="key" data-k="5" type="button">5</button>
            <button class="key" data-k="6" type="button">6</button>
            <button class="key" data-k="7" type="button">7</button>
            <button class="key" data-k="8" type="button">8</button>
            <button class="key" data-k="9" type="button">9</button>
            <button class="key action wide" data-k="del" type="button">‚å´</button>
            <button class="key" data-k="0" type="button">0</button>
            <button class="key action" data-k="ok" type="button">OK</button>
          </div>
        </div>
      </div>
    </section>

    <!-- RESULT -->
    <section class="panel hide" id="screenResult">
      <div class="hd">
        <div class="title">üèÅ Resultat</div>
        <button class="btn" id="btnToOverview">√ñversikt</button>
      </div>
      <div class="bd">
        <div class="resultBig" id="resultBig">GODK√ÑND</div>
        <div class="small" id="resultSub"></div>

        <div class="stats">
          <div class="stat">
            <div class="k">R√§tt</div>
            <div class="v" id="statCorrect">0</div>
          </div>
          <div class="stat">
            <div class="k">Fel</div>
            <div class="v" id="statWrong">0</div>
          </div>
          <div class="stat">
            <div class="k">Snittid</div>
            <div class="v" id="statAvg">‚Äì</div>
          </div>
          <div class="stat">
            <div class="k">Mynt</div>
            <div class="v" id="statCoins">+0</div>
          </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;">
          <button class="btn primary" id="btnAgain">F√∂rs√∂k igen</button>
          <button class="btn" id="btnChangeMode">Byt l√§ge</button>
        </div>
      </div>
    </section>
  </div>

  <div class="confetti" id="confetti"></div>

  <script>
    "use strict";

    /* =========================
       SETTINGS
    ========================== */
    const TEST_SECONDS = 10;   // <-- √§ndrat fr√•n 5 till 10

    /* =========================
       Storage
    ========================== */
    const KEY =KEYY = "tabellhjalte_v2_light";
    const defaultState = () => ({
      coins: 0,
      streak: 0,
      avatar: {
        name: "",
        skin: "#f2c7a5",
        hairLen: "medium",      // short | medium | long | xlong
        hairCol: "#5a3b1f",
        eyeSize: 14,            // px
        top: "#2563eb",
        bottom: "#2f3a46",
        shoes: "#eaeaea",
        unlocked: {
          top: [0,1],
          bottom: [0,1],
          shoes: [0,1]
        }
      },
      progress: Array.from({length:11}, (_,n)=>({
        n,
        passed: false,
        bestAvg: null,
        bestDate: null
      }))
    });

    function loadState(){
      try{
        const raw = localStorage.getItem(KEYY);
        if(!raw) return defaultState();
        const obj = JSON.parse(raw);
        const d = defaultState();
        return {
          ...d,
          ...obj,
          avatar: {
            ...d.avatar,
            ...(obj.avatar||{}),
            unlocked: { ...d.avatar.unlocked, ...((obj.avatar||{}).unlocked||{}) }
          },
          progress: (obj.progress && obj.progress.length===11) ? obj.progress : d.progress
        };
      }catch{
        return defaultState();
      }
    }
    function saveState(){
      localStorage.setItem(KEYY, JSON.stringify(state));
    }
    let state = loadState();

    /* =========================
       DOM
    ========================== */
    const screens = {
      avatar: document.getElementById("screenAvatar"),
      home: document.getElementById("screenHome"),
      mode: document.getElementById("screenMode"),
      game: document.getElementById("screenGame"),
      result: document.getElementById("screenResult"),
    };

    const coinsEl = document.getElementById("coins");
    const streakEl = document.getElementById("streak");
    const homeSub = document.getElementById("homeSub");

    const btnHome = document.getElementById("btnHome");
    const btnAvatar = document.getElementById("btnAvatar");
    const btnReset = document.getElementById("btnReset");

    // Avatar controls
    const inpName = document.getElementById("inpName");
    const segSkin = document.getElementById("segSkin");
    const segHairLen = document.getElementById("segHairLen");
    const segHairCol = document.getElementById("segHairCol");
    const segEyeSize = document.getElementById("segEyeSize");
    const segTop = document.getElementById("segTop");
    const segBottom = document.getElementById("segBottom");
    const segShoes = document.getElementById("segShoes");
    const btnSaveAvatar = document.getElementById("btnSaveAvatar");
    const avatarNamePreview = document.getElementById("avatarNamePreview");

    // Avatar preview
    const face = document.getElementById("face");
    const hair = document.getElementById("hair");
    const shirt = document.getElementById("shirt");
    const pants = document.getElementById("pants");
    const shoeL = document.getElementById("shoeL");
    const shoeR = document.getElementById("shoeR");

    // Home
    const tablesGrid = document.getElementById("tablesGrid");

    // Mode
    const modeTitle = document.getElementById("modeTitle");
    const btnBackFromMode = document.getElementById("btnBackFromMode");
    const btnPractice = document.getElementById("btnPractice");
    const btnSpeed = document.getElementById("btnSpeed");

    // Game
    const gameTitle = document.getElementById("gameTitle");
    const btnQuitGame = document.getElementById("btnQuitGame");
    const questionText = document.getElementById("questionText");
    const progressText = document.getElementById("progressText");
    const correctCount = document.getElementById("correctCount");
    const wrongCount = document.getElementById("wrongCount");
    const answerInput = document.getElementById("answerInput");
    const btnOk = document.getElementById("btnOk");
    const timerRing = document.getElementById("timerRing");
    const timerText = document.getElementById("timerText");
    const tinyHint = document.getElementById("tinyHint");

    // Result
    const resultBig = document.getElementById("resultBig");
    const resultSub = document.getElementById("resultSub");
    const statCorrect = document.getElementById("statCorrect");
    const statWrong = document.getElementById("statWrong");
    const statAvg = document.getElementById("statAvg");
    const statCoins = document.getElementById("statCoins");
    const btnToOverview = document.getElementById("btnToOverview");
    const btnAgain = document.getElementById("btnAgain");
    const btnChangeMode = document.getElementById("btnChangeMode");

    // Confetti
    const confetti = document.getElementById("confetti");

    /* =========================
       Helpers
    ========================== */
    function showScreen(which){
      Object.values(screens).forEach(s=>s.classList.add("hide"));
      screens[which].classList.remove("hide");
    }
    function clampDigits(s){
      return (s || "").replace(/[^\d]/g, "").slice(0, 3);
    }
    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    function nowISO(){ return new Date().toISOString(); }
    function fmt1(x){ return (Math.round(x*10)/10).toFixed(1); }
    function updateTopbar(){
      coinsEl.textContent = state.coins;
      streakEl.textContent = state.streak;
    }

    /* =========================
       Avatar data
    ========================== */
    const skins = ["#f2c7a5","#e0b48c","#c98e6a","#8d5b3a"];
    const hairLens = [
      {label:"Kort", v:"short"},
      {label:"Medel", v:"medium"},
      {label:"L√•ng", v:"long"},
      {label:"Mega", v:"xlong"}      // <-- mycket l√§ngre h√•r
    ];
    const hairCols = ["#111111","#5a3b1f","#caa26a","#c04b2d","#7a7fff"];

    const eyeSizes = [
      {label:"S", v:12},
      {label:"M", v:14},
      {label:"L", v:18}
    ];

    // Outfit with unlock costs
    const tops = [
      { col:"#2563eb", cost:0 },
      { col:"#1fb66a", cost:0 },
      { col:"#f59e0b", cost:25 },
      { col:"#ef4444", cost:25 },
      { col:"#8b5cf6", cost:40 }
    ];
    const bottoms = [
      { col:"#2f3a46", cost:0 },
      { col:"#1f2b38", cost:0 },
      { col:"#6b4f3b", cost:25 },
      { col:"#3b6b5f", cost:25 },
      { col:"#555555", cost:40 }
    ];
    const shoes = [
      { col:"#eaeaea", cost:0 },
      { col:"#111827", cost:0 },
      { col:"#2563eb", cost:25 },
      { col:"#1fb66a", cost:25 },
      { col:"#f59e0b", cost:40 }
    ];

    function makeSeg(container, options, isActiveFn, onPick, styleFn){
      container.innerHTML = "";
      options.forEach((opt, idx)=>{
        const b = document.createElement("button");
        b.type = "button";
        b.textContent = opt.label ?? opt;
        if(isActiveFn(opt, idx)) b.classList.add("active");
        if(styleFn) styleFn(b, opt, idx);
        b.addEventListener("click", ()=>onPick(opt, idx));
        container.appendChild(b);
      });
    }

    function renderOutfitSeg(container, kind, arr, currentCol, setCol){
      const unlocked = state.avatar.unlocked[kind] || [];
      container.innerHTML = "";

      arr.forEach((it, idx)=>{
        const b = document.createElement("button");
        b.type = "button";
        const isUnlocked = unlocked.includes(idx);
        const isActive = it.col === currentCol;

        b.textContent = isUnlocked ? "‚¨§" : `üîí${it.cost}`;
        if(isActive) b.classList.add("active");
        b.style.color = it.col;

        b.addEventListener("click", ()=>{
          if(isUnlocked){
            setCol(it.col);
            applyAvatarPreview();
            saveState();
            renderAvatarUI();
            return;
          }
          if(state.coins >= it.cost){
            state.coins -= it.cost;
            state.avatar.unlocked[kind] = [...new Set([...unlocked, idx])];
            setCol(it.col);
            applyAvatarPreview();
            saveState();
            renderAvatarUI();
          }else{
            flashChip("coinChip");
          }
        });

        container.appendChild(b);
      });
    }

    function applyAvatarPreview(){
      face.style.setProperty("--skin", state.avatar.skin);
      face.style.setProperty("--hair", state.avatar.hairCol);
      face.style.setProperty("--top", state.avatar.top);
      face.style.setProperty("--bottom", state.avatar.bottom);
      face.style.setProperty("--shoes", state.avatar.shoes);
      face.style.setProperty("--eyeSize", (state.avatar.eyeSize || 14) + "px");

      hair.className = `hair ${state.avatar.hairLen || "medium"}`;

      shirt.style.setProperty("--top", state.avatar.top);
      pants.style.setProperty("--bottom", state.avatar.bottom);
      shoeL.style.setProperty("--shoes", state.avatar.shoes);
      shoeR.style.setProperty("--shoes", state.avatar.shoes);

      avatarNamePreview.textContent = state.avatar.name ? `üë§ ${state.avatar.name}` : "üë§";
      updateTopbar();
    }

    function flashChip(id){
      const el = document.getElementById(id);
      el.animate([
        { transform:"scale(1)" },
        { transform:"scale(1.04)" },
        { transform:"scale(1)" }
      ], { duration: 300, easing:"ease-out" });
    }

    function renderAvatarUI(){
      inpName.value = state.avatar.name || "";
      applyAvatarPreview();

      makeSeg(segSkin,
        skins.map(c=>({label:"‚¨§", col:c})),
        (opt)=> opt.col===state.avatar.skin,
        (opt)=>{ state.avatar.skin = opt.col; saveState(); applyAvatarPreview(); renderAvatarUI(); },
        (b,opt)=>{ b.style.color = opt.col; }
      );

      makeSeg(segHairLen,
        hairLens,
        (opt)=> opt.v===state.avatar.hairLen,
        (opt)=>{ state.avatar.hairLen = opt.v; saveState(); applyAvatarPreview(); renderAvatarUI(); }
      );

      makeSeg(segHairCol,
        hairCols.map(c=>({label:"‚¨§", col:c})),
        (opt)=> opt.col===state.avatar.hairCol,
        (opt)=>{ state.avatar.hairCol = opt.col; saveState(); applyAvatarPreview(); renderAvatarUI(); },
        (b,opt)=>{ b.style.color = opt.col; }
      );

      makeSeg(segEyeSize,
        eyeSizes,
        (opt)=> opt.v===state.avatar.eyeSize,
        (opt)=>{ state.avatar.eyeSize = opt.v; saveState(); applyAvatarPreview(); renderAvatarUI(); }
      );

      renderOutfitSeg(segTop, "top", tops, state.avatar.top, (col)=> state.avatar.top = col);
      renderOutfitSeg(segBottom, "bottom", bottoms, state.avatar.bottom, (col)=> state.avatar.bottom = col);
      renderOutfitSeg(segShoes, "shoes", shoes, state.avatar.shoes, (col)=> state.avatar.shoes = col);

      updateTopbar();
    }

    /* =========================
       Home / tables
    ========================== */
    function renderHome(){
      const name = state.avatar.name || "Spelare";
      const passed = state.progress.filter(p=>p.passed).length;
      homeSub.textContent = `${name} ‚Ä¢ ‚≠ê ${passed}/11`;
      tablesGrid.innerHTML = "";

      for(let n=0;n<=10;n++){
        const p = state.progress[n];
        const card = document.createElement("div");
        card.className = "card";

        const left = document.createElement("div");
        left.className = "left";

        const k = document.createElement("div");
        k.className = "k";
        k.textContent = `${n}:an`;

        const s = document.createElement("div");
        s.className = "s";
        if(p.passed){
          const best = (p.bestAvg!=null) ? `${fmt1(p.bestAvg)}s` : "‚Äì";
          s.textContent = `‚≠ê Klar ‚Ä¢ ${best}`;
        }else{
          s.textContent = "üîí Ej klar";
        }

        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = p.passed ? "‚≠ê" : "üîí";

        left.appendChild(k);
        left.appendChild(s);
        card.appendChild(left);
        card.appendChild(badge);

        card.addEventListener("click", ()=>{
          selectedTable = n;
          showMode();
        });

        tablesGrid.appendChild(card);
      }

      updateTopbar();
    }

    /* =========================
       Game logic
    ========================== */
    let selectedTable = 0;
    let selectedMode = "practice"; // practice | speed

    let questions = [];
    let qi = 0;
    let correct = 0;
    let wrong = 0;

    // speed timing
    let qStartMs = 0;
    let qTimer = null;
    let qElapsed = [];
    let speedFailReason = "";

    function buildQuestionsForTable(n){
      const ks = shuffle([...Array(11)].map((_,i)=>i));
      return ks.map(k=>({ n, k, ans: n*k }));
    }

    function showMode(){
      modeTitle.textContent = `üéØ ${selectedTable}:an`;
      showScreen("mode");
    }

    function startGame(mode){
      selectedMode = mode;
      questions = buildQuestionsForTable(selectedTable);
      qi = 0;
      correct = 0;
      wrong = 0;
      qElapsed = [];
      speedFailReason = "";
      updateGameHeader();
      showScreen("game");
      nextQuestion(true);
    }

    function updateGameHeader(){
      gameTitle.textContent = (selectedMode==="speed")
        ? `‚ö° Speed-test ‚Ä¢ ${selectedTable}:an`
        : `üéÆ Tr√§na ‚Ä¢ ${selectedTable}:an`;

      timerRing.classList.toggle("hide", selectedMode!=="speed");
      tinyHint.textContent = (selectedMode==="speed")
        ? `Max ${TEST_SECONDS},0s per fr√•ga ‚Ä¢ Alla m√•ste vara r√§tt`
        : "Svara med knapparna";
      timerText.textContent = `${TEST_SECONDS}.0`;
    }

    function clearTimers(){
      if(qTimer){
        cancelAnimationFrame(qTimer);
        qTimer = null;
      }
    }

    function nextQuestion(isFirst=false){
      clearTimers();
      answerInput.value = "";
      answerInput.classList.remove("good","bad");
      btnOk.disabled = false;

      if(qi >= questions.length){
        finishGame(true);
        return;
      }

      const q = questions[qi];
      questionText.textContent = `${q.n} √ó ${q.k}`;
      progressText.textContent = `${qi+1} / ${questions.length}`;
      correctCount.textContent = correct;
      wrongCount.textContent = wrong;

      // Prevent iOS keyboard entirely: blur if somehow focused
      answerInput.blur();

      if(selectedMode==="speed"){
        startSpeedTimer();
      }
    }

    function startSpeedTimer(){
      qStartMs = performance.now();
      const seconds = TEST_SECONDS;

      const tick = ()=>{
        const now = performance.now();
        const t = (now - qStartMs) / 1000;
        const remaining = Math.max(0, seconds - t);
        const pct = Math.min(100, (t/seconds)*100);

        timerRing.style.setProperty("--p", `${pct}%`);
        timerText.textContent = fmt1(remaining);

        if(remaining <= 0){
          qElapsed.push(seconds);
          speedFailReason = "‚è±Ô∏è Tiden tog slut";
          wrong++;
          wrongCount.textContent = wrong;
          answerInput.classList.add("bad");
          btnOk.disabled = true;
          clearTimers();
          setTimeout(()=>finishGame(false), 350);
          return;
        }
        qTimer = requestAnimationFrame(tick);
      };
      qTimer = requestAnimationFrame(tick);
    }

    function awardCoins(n){
      if(n<=0) return;
      state.coins += n;
      saveState();
      updateTopbar();
    }

    function submitAnswer(){
      const val = clampDigits(answerInput.value);
      answerInput.value = val;
      if(val.length===0) return;

      const q = questions[qi];
      const userAns = parseInt(val, 10);

      if(selectedMode==="speed"){
        const t = (performance.now() - qStartMs)/1000;
        qElapsed.push(Math.min(TEST_SECONDS, t));
      }

      if(userAns === q.ans){
        correct++;
        answerInput.classList.add("good");
        awardCoins(selectedMode==="speed" ? 2 : 1);
        clearTimers();
        qi++;
        setTimeout(()=>nextQuestion(), 120);
      }else{
        wrong++;
        answerInput.classList.add("bad");
        clearTimers();

        if(selectedMode==="speed"){
          speedFailReason = "‚ùå Fel svar";
          btnOk.disabled = true;
          setTimeout(()=>finishGame(false), 350);
        }else{
          btnOk.disabled = true;
          const prev = questionText.textContent;
          questionText.textContent = `${prev} = ${q.ans}`;
          setTimeout(()=>{
            questionText.textContent = prev;
            qi++;
            nextQuestion();
          }, 650);
        }
      }

      correctCount.textContent = correct;
      wrongCount.textContent = wrong;
    }

    function finishGame(passedAll){
      clearTimers();
      const total = questions.length;
      const isSpeed = selectedMode==="speed";

      let passed = false;
      if(isSpeed){
        passed = passedAll && correct === total && wrong === 0 && qElapsed.length === total;
      }

      if(isSpeed){
        state.streak = passed ? (state.streak + 1) : 0;
      }

      let coinBonus = 0;
      let newlyPassed = false;

      if(isSpeed && passed){
        coinBonus = 20;
        state.coins += coinBonus;

        const p = state.progress[selectedTable];
        if(!p.passed) newlyPassed = true;
        p.passed = true;

        const avg = qElapsed.reduce((a,b)=>a+b,0) / qElapsed.length;
        if(p.bestAvg == null || avg < p.bestAvg){
          p.bestAvg = avg;
          p.bestDate = nowISO();
        }
      }

      hookupResultUI(isSpeed, passed, total, coinBonus);
      saveState();
      updateTopbar();
      renderHome();
      showScreen("result");

      lastResult = { table:selectedTable, mode:selectedMode };

      if(newlyPassed) popConfetti();
    }

    function hookupResultUI(isSpeed, passed, total, coinBonus){
      if(isSpeed){
        resultBig.textContent = passed ? "GODK√ÑND" : "EJ GODK√ÑND";
        resultBig.style.color = passed ? "var(--good)" : "var(--bad)";
        resultSub.textContent = passed
          ? `‚≠ê ${selectedTable}:an klar!`
          : (speedFailReason || `Max ${TEST_SECONDS},0s per fr√•ga ‚Ä¢ alla r√§tt`);
      }else{
        resultBig.textContent = "KLART";
        resultBig.style.color = "var(--txt)";
        resultSub.textContent = "Tr√§ning";
      }

      statCorrect.textContent = `${correct}/${total}`;
      statWrong.textContent = `${wrong}`;
      statAvg.textContent = (isSpeed && qElapsed.length>0)
        ? `${fmt1(qElapsed.reduce((a,b)=>a+b,0)/qElapsed.length)}s`
        : "‚Äì";

      const coinGain = (isSpeed ? (correct*2 + coinBonus) : (correct*1));
      statCoins.textContent = `+${coinGain}`;
    }

    let lastResult = { table:0, mode:"practice" };

    /* =========================
       Confetti
    ========================== */
    function popConfetti(){
      confetti.innerHTML = "";
      const count = 90;
      const cols = ["rgba(37,99,235,.95)","rgba(31,182,106,.95)","rgba(245,158,11,.95)","rgba(239,68,68,.90)","rgba(139,92,246,.95)"];
      for(let i=0;i<count;i++){
        const p = document.createElement("i");
        p.style.left = (Math.random()*100) + "vw";
        p.style.animationDelay = (Math.random()*0.15) + "s";
        p.style.setProperty("--r", (Math.random()*360) + "deg");
        p.style.width = (6 + Math.random()*8) + "px";
        p.style.height = (10 + Math.random()*10) + "px";
        p.style.background = cols[Math.floor(Math.random()*cols.length)];
        confetti.appendChild(p);
      }
      confetti.classList.add("show");
      setTimeout(()=>confetti.classList.remove("show"), 1300);
    }

    /* =========================
       Keypad (NO iPhone keyboard)
    ========================== */
    function appendDigit(d){
      answerInput.value = clampDigits(answerInput.value + d);
      // never focus -> avoids iOS keyboard
      answerInput.blur();
    }
    function backspace(){
      answerInput.value = answerInput.value.slice(0, -1);
      answerInput.blur();
    }

    document.querySelectorAll(".keypad .key").forEach(b=>{
      b.addEventListener("click", ()=>{
        const k = b.getAttribute("data-k");
        if(k==="del"){ backspace(); return; }
        if(k==="ok"){ submitAnswer(); return; }
        appendDigit(k);
      });
    });

    // Also block keyboard if user taps the answer field
    answerInput.addEventListener("pointerdown", (e)=>{
      e.preventDefault();
      answerInput.blur();
    });

    btnOk.addEventListener("click", submitAnswer);

    /* =========================
       Navigation
    ========================== */
    btnHome.addEventListener("click", ()=>{
      renderHome();
      showScreen("home");
    });

    btnAvatar.addEventListener("click", ()=>{
      showScreen("avatar");
      renderAvatarUI();
    });

    btnReset.addEventListener("click", ()=>{
      localStorage.removeItem(KEYY);
      state = defaultState();
      saveState();
      init();
      showScreen("avatar");
    });

    btnSaveAvatar.addEventListener("click", ()=>{
      state.avatar.name = (inpName.value || "").trim().slice(0, 16);
      saveState();
      applyAvatarPreview();
      renderHome();
      showScreen("home");
    });

    inpName.addEventListener("input", ()=>{
      state.avatar.name = (inpName.value || "").trim().slice(0, 16);
      saveState();
      applyAvatarPreview();
    });

    btnBackFromMode.addEventListener("click", ()=>{
      renderHome();
      showScreen("home");
    });

    btnPractice.addEventListener("click", ()=> startGame("practice"));
    btnSpeed.addEventListener("click", ()=> startGame("speed"));

    btnQuitGame.addEventListener("click", ()=>{
      clearTimers();
      renderHome();
      showScreen("home");
    });

    btnToOverview.addEventListener("click", ()=>{
      renderHome();
      showScreen("home");
    });

    btnAgain.addEventListener("click", ()=>{
      startGame(lastResult.mode);
    });

    btnChangeMode.addEventListener("click", ()=>{
      showMode();
    });

    /* =========================
       Init
    ========================== */
    function renderHomeAndAvatar(){
      renderAvatarUI();
      renderHome();
      updateTopbar();
    }

    function init(){
      renderHomeAndAvatar();

      // First run: go avatar if no name
      if((state.avatar.name || "").trim().length === 0){
        showScreen("avatar");
      }else{
        showScreen("home");
      }
    }

    init();
  </script>
</body>
</html>