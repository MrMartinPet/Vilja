<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tabellhj√§lte</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#121a24;
      --panel2:#0f1620;
      --txt:#eaf2ff;
      --muted:#9fb3c8;
      --good:#2ecc71;
      --bad:#ff4d4d;
      --accent:#4da3ff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --btn: 52px;
      --gap: 12px;
      --maxw: 980px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1000px 500px at 50% -20%, rgba(77,163,255,.25), transparent 60%),
                  radial-gradient(900px 600px at 0% 120%, rgba(46,204,113,.15), transparent 60%),
                  var(--bg);
      color:var(--txt);
      min-height:100vh;
      display:flex;
      justify-content:center;
    }
    .app{
      width:100%;
      max-width:var(--maxw);
      padding:16px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:8px 12px;
      border-radius:999px;
      box-shadow: var(--shadow);
      user-select:none;
    }
    .chip b{ font-weight:800; }
    .btn{
      border:none;
      border-radius:999px;
      padding:10px 14px;
      background: rgba(255,255,255,.08);
      color:var(--txt);
      border:1px solid rgba(255,255,255,.14);
      cursor:pointer;
      font-weight:700;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(77,163,255,.95), rgba(77,163,255,.65));
      border:1px solid rgba(77,163,255,.35);
    }
    .btn.good{
      background: linear-gradient(180deg, rgba(46,204,113,.95), rgba(46,204,113,.65));
      border:1px solid rgba(46,204,113,.35);
    }
    .btn.danger{
      background: rgba(255,77,77,.12);
      border: 1px solid rgba(255,77,77,.35);
      color:#ffd6d6;
    }
    .panel{
      background: linear-gradient(180deg, rgba(18,26,36,.92), rgba(15,22,32,.92));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding:14px 14px 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .panel .hd .title{
      font-weight:900;
      font-size:16px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .panel .bd{
      padding:14px;
    }

    /* Layouts */
    .grid{
      display:grid;
      gap: var(--gap);
    }
    .grid.tables{
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
    @media (min-width: 760px){
      .grid.tables{ grid-template-columns: repeat(6, minmax(0, 1fr)); }
    }
    .card{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 14px;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-height:60px;
    }
    .card:active{ transform: translateY(1px); }
    .card .left{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .card .k{
      font-weight:900;
      font-size:16px;
      line-height:1;
    }
    .card .s{
      font-size:12px;
      color:var(--muted);
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:34px;height:34px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size:18px;
    }

    /* Mode buttons */
    .modes{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 640px){
      .modes{ grid-template-columns: 1fr 1fr; }
    }
    .modeBtn{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:16px;
      border-radius:18px;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
    }
    .modeBtn:active{ transform: translateY(1px); }
    .modeBtn .t{
      font-weight:900;
      font-size:16px;
    }
    .modeBtn .d{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
    .modeBtn .icon{
      width:42px;height:42px;
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      font-size:18px;
    }

    /* Game */
    .gameWrap{
      display:grid;
      gap:12px;
    }
    .qBox{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .question{
      font-size:34px;
      font-weight:900;
      letter-spacing:.3px;
    }
    .sub{
      color:var(--muted);
      font-size:12px;
      font-weight:700;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      font-weight:800;
    }

    /* Timer ring */
    .timerRing{
      width:44px;height:44px;
      border-radius:999px;
      display:grid;
      place-items:center;
      background:
        conic-gradient(var(--accent) var(--p, 0%), rgba(255,255,255,.10) 0);
      border:1px solid rgba(255,255,255,.12);
    }
    .timerRing span{
      font-size:12px;
      font-weight:900;
      color:var(--txt);
    }

    /* Input */
    .answerRow{
      display:flex;
      gap:10px;
      align-items:stretch;
    }
    .answer{
      flex:1;
      font-size:24px;
      font-weight:900;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color:var(--txt);
      outline:none;
      text-align:center;
    }
    .answer.good{ border-color: rgba(46,204,113,.6); }
    .answer.bad{ border-color: rgba(255,77,77,.7); }
    .okBtn{
      min-width:92px;
      font-size:16px;
      font-weight:900;
      border-radius:16px;
    }
    .okBtn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }
    .keypad{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .key{
      height: var(--btn);
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color:var(--txt);
      font-size:18px;
      font-weight:900;
      cursor:pointer;
    }
    .key:active{ transform: translateY(1px); }
    .key.wide{ grid-column: span 2; }
    .key.action{
      background: rgba(77,163,255,.14);
      border-color: rgba(77,163,255,.35);
    }

    /* Avatar */
    .avatarLayout{
      display:grid;
      gap:12px;
    }
    @media (min-width: 760px){
      .avatarLayout{
        grid-template-columns: 320px 1fr;
        align-items:start;
      }
    }
    .avatarPreview{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .avatarStage{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background: radial-gradient(600px 400px at 50% 0%, rgba(77,163,255,.18), transparent 55%),
                  rgba(255,255,255,.04);
      display:grid;
      place-items:center;
      position:relative;
      overflow:hidden;
    }
    .avatarStage .face{
      width:140px;height:140px;
      border-radius:40px;
      position:relative;
      border:1px solid rgba(255,255,255,.12);
      background: var(--skin, #f2c7a5);
      box-shadow: 0 12px 25px rgba(0,0,0,.25);
    }
    .hair{
      position:absolute;
      left:10px; right:10px;
      top:-8px;
      height:58px;
      border-radius: 30px 30px 26px 26px;
      background: var(--hair, #5a3b1f);
      border:1px solid rgba(0,0,0,.25);
    }
    .hair.short{ height:42px; top:-6px; }
    .hair.medium{ height:58px; }
    .hair.long{ height:78px; top:-10px; border-radius: 34px 34px 30px 30px; }
    .eyes{
      position:absolute;
      top:56px; left:0; right:0;
      display:flex;
      justify-content:center;
      gap:22px;
    }
    .eye{
      width:14px;height:14px;border-radius:999px;
      background: var(--eye, #2b2b2b);
      box-shadow: inset 0 -2px 0 rgba(255,255,255,.15);
    }
    .mouth{
      position:absolute;
      bottom:28px; left:50%;
      width:42px;height:18px;
      transform: translateX(-50%);
      border-bottom: 5px solid rgba(0,0,0,.35);
      border-radius: 0 0 999px 999px;
      opacity:.85;
    }
    .body{
      position:absolute;
      bottom:-14px; left:50%;
      transform: translateX(-50%);
      width:190px;height:130px;
      border-radius: 40px 40px 26px 26px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.10);
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding:16px;
      gap:10px;
    }
    .shirt{
      width:110px;height:70px;
      border-radius:18px;
      background: var(--top, #4da3ff);
      border:1px solid rgba(0,0,0,.18);
    }
    .pants{
      width:110px;height:34px;
      border-radius:14px;
      background: var(--bottom, #2f3a46);
      border:1px solid rgba(0,0,0,.18);
      margin-top:8px;
    }
    .shoeRow{
      display:flex;
      gap:10px;
      position:absolute;
      bottom:8px;
    }
    .shoe{
      width:46px;height:18px;border-radius:999px;
      background: var(--shoes, #eaeaea);
      border:1px solid rgba(0,0,0,.18);
    }

    .controls{
      display:grid;
      gap:12px;
    }
    .control{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius:18px;
      padding:12px;
    }
    .control .lbl{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      margin-bottom:8px;
    }
    .control .row2{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .seg{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .seg button{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color:var(--txt);
      font-weight:900;
      cursor:pointer;
    }
    .seg button.active{
      background: rgba(77,163,255,.20);
      border-color: rgba(77,163,255,.35);
    }
    .textInput{
      width:100%;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color:var(--txt);
      font-size:16px;
      font-weight:800;
      outline:none;
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
      font-weight:700;
    }

    /* Result */
    .resultBig{
      font-size:32px;
      font-weight:1000;
      letter-spacing:.3px;
    }
    .stats{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .stat{
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .stat .k{ color:var(--muted); font-size:12px; font-weight:900; }
    .stat .v{ font-size:18px; font-weight:1000; margin-top:4px; }

    /* Confetti */
    .confetti{
      position:fixed;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index:999;
      display:none;
    }
    .confetti.show{ display:block; }
    .confetti i{
      position:absolute;
      top:-12px;
      width:10px;height:16px;
      border-radius:3px;
      background: rgba(255,255,255,.9);
      opacity:.9;
      animation: fall 1.2s linear forwards;
      transform: rotate(var(--r, 0deg));
    }
    @keyframes fall{
      to{ transform: translateY(110vh) rotate(calc(var(--r, 0deg) + 260deg)); opacity:.0; }
    }

    /* Utility */
    .hide{ display:none !important; }
    .muted{ color:var(--muted); }
    .small{ font-size:12px; font-weight:700; color:var(--muted); }
    .spacer{ height:4px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="chip">‚öîÔ∏è <b>Tabellhj√§lte</b></div>
        <div class="chip" id="coinChip">ü™ô <b id="coins">0</b></div>
        <div class="chip">üî• <b id="streak">0</b></div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn" id="btnHome">√ñversikt</button>
        <button class="btn" id="btnAvatar">Avatar</button>
        <button class="btn danger" id="btnReset" title="Rensa allt">Reset</button>
      </div>
    </div>

    <!-- AVATAR -->
    <section class="panel" id="screenAvatar">
      <div class="hd">
        <div class="title">üé≠ Avatar</div>
        <button class="btn primary" id="btnSaveAvatar">Spara</button>
      </div>
      <div class="bd">
        <div class="avatarLayout">
          <div class="avatarPreview">
            <div class="avatarStage" id="avatarStage">
              <div class="face" id="face">
                <div class="hair medium" id="hair"></div>
                <div class="eyes">
                  <div class="eye"></div>
                  <div class="eye"></div>
                </div>
                <div class="mouth"></div>
              </div>
              <div class="body">
                <div>
                  <div class="shirt" id="shirt"></div>
                  <div class="pants" id="pants"></div>
                </div>
                <div class="shoeRow">
                  <div class="shoe" id="shoeL"></div>
                  <div class="shoe" id="shoeR"></div>
                </div>
              </div>
            </div>
            <div class="small" id="avatarNamePreview"></div>
          </div>

          <div class="controls">
            <div class="control">
              <div class="lbl">Namn</div>
              <input class="textInput" id="inpName" placeholder="Skriv namn" autocomplete="off" />
            </div>

            <div class="control">
              <div class="lbl">Hudton</div>
              <div class="seg" id="segSkin"></div>
            </div>

            <div class="control">
              <div class="lbl">H√•r</div>
              <div class="row2">
                <div class="seg" id="segHairLen"></div>
              </div>
              <div class="spacer"></div>
              <div class="seg" id="segHairCol"></div>
            </div>

            <div class="control">
              <div class="lbl">Kl√§der</div>
              <div class="hint">K√∂p med ü™ô om du vill. (Gratis = f√∂rsta tv√•)</div>
              <div class="spacer"></div>
              <div class="lbl">Topp</div>
              <div class="seg" id="segTop"></div>
              <div class="spacer"></div>
              <div class="lbl">Byxa</div>
              <div class="seg" id="segBottom"></div>
              <div class="spacer"></div>
              <div class="lbl">Skor</div>
              <div class="seg" id="segShoes"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- HOME / TABLES -->
    <section class="panel hide" id="screenHome">
      <div class="hd">
        <div class="title">üß† Tabeller 0‚Äì10</div>
        <div class="small" id="homeSub"></div>
      </div>
      <div class="bd">
        <div class="grid tables" id="tablesGrid"></div>
      </div>
    </section>

    <!-- MODE SELECT -->
    <section class="panel hide" id="screenMode">
      <div class="hd">
        <div class="title" id="modeTitle">üéØ</div>
        <button class="btn" id="btnBackFromMode">Tillbaka</button>
      </div>
      <div class="bd">
        <div class="modes">
          <div class="modeBtn" id="btnPractice">
            <div>
              <div class="t">Tr√§na</div>
              <div class="d">Inga tidskrav</div>
            </div>
            <div class="icon">üéÆ</div>
          </div>
          <div class="modeBtn" id="btnSpeed">
            <div>
              <div class="t">Speed-test</div>
              <div class="d">5 sek per fr√•ga ‚Ä¢ kr√§vs f√∂r ‚≠ê</div>
            </div>
            <div class="icon">‚ö°</div>
          </div>
        </div>
      </div>
    </section>

    <!-- GAME -->
    <section class="panel hide" id="screenGame">
      <div class="hd">
        <div class="title" id="gameTitle">üéÆ</div>
        <button class="btn" id="btnQuitGame">Avsluta</button>
      </div>
      <div class="bd">
        <div class="gameWrap">
          <div class="qBox">
            <div class="row">
              <div>
                <div class="question" id="questionText">7 √ó 4</div>
                <div class="sub" id="progressText">1 / 11</div>
              </div>
              <div style="display:flex; gap:10px; align-items:center;">
                <div class="pill" title="R√§tt">
                  ‚úÖ <span id="correctCount">0</span>
                </div>
                <div class="pill" title="Fel">
                  ‚ùå <span id="wrongCount">0</span>
                </div>
                <div class="timerRing hide" id="timerRing" style="--p:0%;">
                  <span id="timerText">5.0</span>
                </div>
              </div>
            </div>

            <div class="answerRow">
              <input class="answer" id="answerInput" inputmode="numeric" pattern="[0-9]*" placeholder="Svar" />
              <button class="btn primary okBtn" id="btnOk">OK</button>
            </div>
          </div>

          <div class="keypad" aria-label="Tangentbord">
            <button class="key" data-k="1">1</button>
            <button class="key" data-k="2">2</button>
            <button class="key" data-k="3">3</button>
            <button class="key" data-k="4">4</button>
            <button class="key" data-k="5">5</button>
            <button class="key" data-k="6">6</button>
            <button class="key" data-k="7">7</button>
            <button class="key" data-k="8">8</button>
            <button class="key" data-k="9">9</button>
            <button class="key action wide" data-k="del">‚å´</button>
            <button class="key" data-k="0">0</button>
            <button class="key action" data-k="ok">OK</button>
          </div>

          <div class="small muted" id="tinyHint"></div>
        </div>
      </div>
    </section>

    <!-- RESULT -->
    <section class="panel hide" id="screenResult">
      <div class="hd">
        <div class="title">üèÅ Resultat</div>
        <button class="btn" id="btnToOverview">√ñversikt</button>
      </div>
      <div class="bd">
        <div class="resultBig" id="resultBig">GODK√ÑND</div>
        <div class="small" id="resultSub"></div>

        <div class="stats">
          <div class="stat">
            <div class="k">R√§tt</div>
            <div class="v" id="statCorrect">0</div>
          </div>
          <div class="stat">
            <div class="k">Fel</div>
            <div class="v" id="statWrong">0</div>
          </div>
          <div class="stat">
            <div class="k">Snittid</div>
            <div class="v" id="statAvg">‚Äì</div>
          </div>
          <div class="stat">
            <div class="k">Mynt</div>
            <div class="v" id="statCoins">+0</div>
          </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;">
          <button class="btn primary" id="btnAgain">F√∂rs√∂k igen</button>
          <button class="btn" id="btnChangeMode">Byt l√§ge</button>
        </div>
      </div>
    </section>
  </div>

  <div class="confetti" id="confetti"></div>

  <script>
    "use strict";

    // --------- Storage ---------
    const KEY = "tabellhjalte_v1";
    const defaultState = () => ({
      coins: 0,
      streak: 0,
      avatar: {
        name: "",
        skin: "#f2c7a5",
        hairLen: "medium",
        hairCol: "#5a3b1f",
        top: "#4da3ff",
        bottom: "#2f3a46",
        shoes: "#eaeaea",
        unlocked: {
          top: [0,1],
          bottom: [0,1],
          shoes: [0,1]
        }
      },
      progress: Array.from({length:11}, (_,n)=>({
        n,
        passed: false,
        bestAvg: null,
        bestDate: null
      }))
    });

    function loadState(){
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return defaultState();
        const obj = JSON.parse(raw);
        // Merge with defaults to avoid missing fields after updates
        const d = defaultState();
        return {
          ...d,
          ...obj,
          avatar: { ...d.avatar, ...(obj.avatar||{}), unlocked: {...d.avatar.unlocked, ...((obj.avatar||{}).unlocked||{})} },
          progress: (obj.progress && obj.progress.length===11) ? obj.progress : d.progress
        };
      }catch{
        return defaultState();
      }
    }
    function saveState(){
      localStorage.setItem(KEY, JSON.stringify(state));
    }

    let state = loadState();

    // --------- DOM ---------
    const screens = {
      avatar: document.getElementById("screenAvatar"),
      home: document.getElementById("screenHome"),
      mode: document.getElementById("screenMode"),
      game: document.getElementById("screenGame"),
      result: document.getElementById("screenResult"),
    };

    const coinsEl = document.getElementById("coins");
    const streakEl = document.getElementById("streak");
    const homeSub = document.getElementById("homeSub");

    const btnHome = document.getElementById("btnHome");
    const btnAvatar = document.getElementById("btnAvatar");
    const btnReset = document.getElementById("btnReset");

    // Avatar controls
    const inpName = document.getElementById("inpName");
    const segSkin = document.getElementById("segSkin");
    const segHairLen = document.getElementById("segHairLen");
    const segHairCol = document.getElementById("segHairCol");
    const segTop = document.getElementById("segTop");
    const segBottom = document.getElementById("segBottom");
    const segShoes = document.getElementById("segShoes");
    const btnSaveAvatar = document.getElementById("btnSaveAvatar");
    const avatarNamePreview = document.getElementById("avatarNamePreview");

    // Avatar preview
    const face = document.getElementById("face");
    const hair = document.getElementById("hair");
    const shirt = document.getElementById("shirt");
    const pants = document.getElementById("pants");
    const shoeL = document.getElementById("shoeL");
    const shoeR = document.getElementById("shoeR");

    // Home/tables
    const tablesGrid = document.getElementById("tablesGrid");

    // Mode
    const modeTitle = document.getElementById("modeTitle");
    const btnBackFromMode = document.getElementById("btnBackFromMode");
    const btnPractice = document.getElementById("btnPractice");
    const btnSpeed = document.getElementById("btnSpeed");

    // Game
    const gameTitle = document.getElementById("gameTitle");
    const btnQuitGame = document.getElementById("btnQuitGame");
    const questionText = document.getElementById("questionText");
    const progressText = document.getElementById("progressText");
    const correctCount = document.getElementById("correctCount");
    const wrongCount = document.getElementById("wrongCount");
    const answerInput = document.getElementById("answerInput");
    const btnOk = document.getElementById("btnOk");
    const timerRing = document.getElementById("timerRing");
    const timerText = document.getElementById("timerText");
    const tinyHint = document.getElementById("tinyHint");

    // Result
    const resultBig = document.getElementById("resultBig");
    const resultSub = document.getElementById("resultSub");
    const statCorrect = document.getElementById("statCorrect");
    const statWrong = document.getElementById("statWrong");
    const statAvg = document.getElementById("statAvg");
    const statCoins = document.getElementById("statCoins");
    const btnToOverview = document.getElementById("btnToOverview");
    const btnAgain = document.getElementById("btnAgain");
    const btnChangeMode = document.getElementById("btnChangeMode");

    // Confetti
    const confetti = document.getElementById("confetti");

    // --------- Helpers ---------
    function showScreen(which){
      Object.values(screens).forEach(s=>s.classList.add("hide"));
      screens[which].classList.remove("hide");
    }
    function clampIntStr(s){
      const v = (s || "").replace(/[^\d]/g, "");
      return v.slice(0, 3);
    }
    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    function nowISO(){
      return new Date().toISOString();
    }
    function fmt1(x){
      return (Math.round(x*10)/10).toFixed(1);
    }
    function updateTopbar(){
      coinsEl.textContent = state.coins;
      streakEl.textContent = state.streak;
    }

    // --------- Avatar data ---------
    const skins = ["#f2c7a5","#e0b48c","#c98e6a","#8d5b3a"];
    const hairLens = ["short","medium","long"];
    const hairCols = ["#111111","#5a3b1f","#caa26a","#c04b2d","#7a7fff"];

    // Outfit palettes with simple "unlock" costs
    const tops = [
      { col:"#4da3ff", cost:0 },
      { col:"#2ecc71", cost:0 },
      { col:"#ffb020", cost:25 },
      { col:"#ff4d4d", cost:25 },
      { col:"#b36bff", cost:40 }
    ];
    const bottoms = [
      { col:"#2f3a46", cost:0 },
      { col:"#1f2b38", cost:0 },
      { col:"#6b4f3b", cost:25 },
      { col:"#3b6b5f", cost:25 },
      { col:"#555555", cost:40 }
    ];
    const shoes = [
      { col:"#eaeaea", cost:0 },
      { col:"#1a1a1a", cost:0 },
      { col:"#4da3ff", cost:25 },
      { col:"#2ecc71", cost:25 },
      { col:"#ffb020", cost:40 }
    ];

    function makeSeg(container, options, getActive, onPick){
      container.innerHTML = "";
      options.forEach((opt, idx)=>{
        const b = document.createElement("button");
        b.textContent = opt.label ?? opt;
        b.className = getActive(opt, idx) ? "active" : "";
        b.addEventListener("click", ()=>onPick(opt, idx));
        container.appendChild(b);
      });
    }

    function renderAvatarUI(){
      inpName.value = state.avatar.name || "";
      avatarNamePreview.textContent = state.avatar.name ? `üë§ ${state.avatar.name}` : "üë§";

      // Skin
      makeSeg(segSkin, skins.map((c,i)=>({label:"‚¨§", col:c, i})), (opt)=> opt.col===state.avatar.skin, (opt)=>{
        state.avatar.skin = opt.col;
        applyAvatarPreview();
        saveState();
        renderAvatarUI();
      });
      // Color the buttons for skins
      [...segSkin.querySelectorAll("button")].forEach((b, i)=>{
        b.style.color = skins[i];
        b.style.borderColor = "rgba(255,255,255,.12)";
      });

      // Hair length
      makeSeg(segHairLen, [
        {label:"Kort", v:"short"},
        {label:"Medel", v:"medium"},
        {label:"L√•ng", v:"long"}
      ], (opt)=> opt.v===state.avatar.hairLen, (opt)=>{
        state.avatar.hairLen = opt.v;
        applyAvatarPreview();
        saveState();
        renderAvatarUI();
      });

      // Hair color
      makeSeg(segHairCol, hairCols.map((c)=>({label:"‚¨§", col:c})), (opt)=> opt.col===state.avatar.hairCol, (opt)=>{
        state.avatar.hairCol = opt.col;
        applyAvatarPreview();
        saveState();
        renderAvatarUI();
      });
      [...segHairCol.querySelectorAll("button")].forEach((b, i)=>{
        b.style.color = hairCols[i];
      });

      // Outfit (with unlock)
      renderOutfitSeg(segTop, "top", tops, state.avatar.top, (col)=>{ state.avatar.top = col; });
      renderOutfitSeg(segBottom, "bottom", bottoms, state.avatar.bottom, (col)=>{ state.avatar.bottom = col; });
      renderOutfitSeg(segShoes, "shoes", shoes, state.avatar.shoes, (col)=>{ state.avatar.shoes = col; });

      updateTopbar();
    }

    function renderOutfitSeg(container, kind, arr, currentCol, setCol){
      const unlocked = state.avatar.unlocked[kind] || [];
      container.innerHTML = "";
      arr.forEach((it, idx)=>{
        const b = document.createElement("button");
        const isUnlocked = unlocked.includes(idx);
        const isActive = it.col === currentCol;

        b.textContent = isUnlocked ? "‚¨§" : `üîí${it.cost}`;
        b.className = isActive ? "active" : "";
        b.style.color = it.col;

        b.addEventListener("click", ()=>{
          if(isUnlocked){
            setCol(it.col);
            applyAvatarPreview();
            saveState();
            renderAvatarUI();
            return;
          }
          // Try buy
          if(state.coins >= it.cost){
            state.coins -= it.cost;
            state.avatar.unlocked[kind] = [...new Set([...unlocked, idx])];
            setCol(it.col);
            applyAvatarPreview();
            saveState();
            renderAvatarUI();
          }else{
            // minimal feedback
            flashChip("coinChip");
          }
        });
        container.appendChild(b);
      });
    }

    function applyAvatarPreview(){
      face.style.setProperty("--skin", state.avatar.skin);
      hair.style.setProperty("--hair", state.avatar.hairCol);
      hair.className = `hair ${state.avatar.hairLen}`;
      shirt.style.setProperty("--top", state.avatar.top);
      pants.style.setProperty("--bottom", state.avatar.bottom);
      shoeL.style.setProperty("--shoes", state.avatar.shoes);
      shoeR.style.setProperty("--shoes", state.avatar.shoes);
      avatarNamePreview.textContent = state.avatar.name ? `üë§ ${state.avatar.name}` : "üë§";
      updateTopbar();
    }

    function flashChip(id){
      const el = document.getElementById(id);
      el.animate([
        { transform:"scale(1)", background:"rgba(255,255,255,.06)" },
        { transform:"scale(1.04)", background:"rgba(255,77,77,.20)" },
        { transform:"scale(1)", background:"rgba(255,255,255,.06)" }
      ], { duration: 380, easing:"ease-out" });
    }

    // --------- Home / tables ---------
    function renderHome(){
      const name = state.avatar.name || "Spelare";
      const passed = state.progress.filter(p=>p.passed).length;
      homeSub.textContent = `${name} ‚Ä¢ ‚≠ê ${passed}/11`;
      tablesGrid.innerHTML = "";

      for(let n=0;n<=10;n++){
        const p = state.progress[n];
        const card = document.createElement("div");
        card.className = "card";
        const left = document.createElement("div");
        left.className = "left";
        const k = document.createElement("div");
        k.className = "k";
        k.textContent = `${n}:an`;
        const s = document.createElement("div");
        s.className = "s";

        if(p.passed){
          const best = (p.bestAvg!=null) ? `${fmt1(p.bestAvg)}s` : "‚Äì";
          s.textContent = `‚≠ê Klar ‚Ä¢ ${best}`;
        }else{
          s.textContent = "üîí Ej klar";
        }

        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = p.passed ? "‚≠ê" : "üîí";

        left.appendChild(k);
        left.appendChild(s);
        card.appendChild(left);
        card.appendChild(badge);

        card.addEventListener("click", ()=>{
          selectedTable = n;
          showMode();
        });

        tablesGrid.appendChild(card);
      }
      updateTopbar();
    }

    // --------- Game logic ---------
    let selectedTable = 0;
    let selectedMode = "practice"; // practice | speed

    let questions = [];
    let qi = 0;
    let correct = 0;
    let wrong = 0;

    // timing for speed mode
    let qStartMs = 0;
    let qTimer = null;
    let qElapsed = []; // seconds per question (answered or timeout)
    let speedFailReason = "";

    function buildQuestionsForTable(n){
      // include 0..10, shuffle order for fun
      const ks = shuffle([...Array(11)].map((_,i)=>i));
      return ks.map(k=>({ n, k, ans: n*k }));
    }

    function showMode(){
      modeTitle.textContent = `üéØ ${selectedTable}:an`;
      showScreen("mode");
    }

    function startGame(mode){
      selectedMode = mode;
      questions = buildQuestionsForTable(selectedTable);
      qi = 0;
      correct = 0;
      wrong = 0;
      qElapsed = [];
      speedFailReason = "";
      updateGameHeader();
      showScreen("game");
      nextQuestion(true);
    }

    function updateGameHeader(){
      gameTitle.textContent = (selectedMode==="speed")
        ? `‚ö° Speed-test ‚Ä¢ ${selectedTable}:an`
        : `üéÆ Tr√§na ‚Ä¢ ${selectedTable}:an`;

      timerRing.classList.toggle("hide", selectedMode!=="speed");
      tinyHint.textContent = (selectedMode==="speed")
        ? "Max 5,0s per fr√•ga ‚Ä¢ Alla m√•ste vara r√§tt"
        : "";
    }

    function nextQuestion(isFirst=false){
      clearTimers();
      answerInput.value = "";
      answerInput.classList.remove("good","bad");
      btnOk.disabled = false;

      if(qi >= questions.length){
        finishGame(true);
        return;
      }

      const q = questions[qi];
      questionText.textContent = `${q.n} √ó ${q.k}`;
      progressText.textContent = `${qi+1} / ${questions.length}`;
      correctCount.textContent = correct;
      wrongCount.textContent = wrong;

      // focus input (helps iPhone show numeric keyboard)
      // Use a tiny timeout to improve mobile focus reliability.
      setTimeout(()=> {
        answerInput.focus({preventScroll:true});
      }, isFirst ? 80 : 30);

      if(selectedMode==="speed"){
        startSpeedTimer();
      }else{
        // practice: no timer
      }
    }

    function startSpeedTimer(){
      qStartMs = performance.now();
      let last = qStartMs;

      const tick = ()=>{
        const now = performance.now();
        const t = (now - qStartMs) / 1000;
        const remaining = Math.max(0, 5 - t);
        const pct = Math.min(100, (t/5)*100);

        timerRing.style.setProperty("--p", `${pct}%`);
        timerText.textContent = fmt1(remaining);

        if(remaining <= 0){
          // timeout
          qElapsed.push(5.0);
          speedFailReason = "‚è±Ô∏è Tiden tog slut";
          wrong++;
          wrongCount.textContent = wrong;
          answerInput.classList.add("bad");
          btnOk.disabled = true;
          clearTimers();
          // finish immediately (simplest)
          setTimeout(()=>finishGame(false), 350);
          return;
        }
        last = now;
        qTimer = requestAnimationFrame(tick);
      };
      qTimer = requestAnimationFrame(tick);
    }

    function clearTimers(){
      if(qTimer){
        cancelAnimationFrame(qTimer);
        qTimer = null;
      }
    }

    function submitAnswer(){
      const val = clampIntStr(answerInput.value);
      answerInput.value = val;
      if(val.length===0) return;

      const q = questions[qi];
      const userAns = parseInt(val, 10);

      // record elapsed in speed mode
      if(selectedMode==="speed"){
        const t = (performance.now() - qStartMs)/1000;
        qElapsed.push(Math.min(5.0, t));
      }

      if(userAns === q.ans){
        correct++;
        answerInput.classList.add("good");
        awardCoins(selectedMode==="speed" ? 2 : 1);
        // next
        clearTimers();
        qi++;
        setTimeout(()=>nextQuestion(), 120);
      }else{
        wrong++;
        answerInput.classList.add("bad");
        awardCoins(0);
        clearTimers();

        if(selectedMode==="speed"){
          speedFailReason = "‚ùå Fel svar";
          btnOk.disabled = true;
          setTimeout(()=>finishGame(false), 350);
        }else{
          // practice: show correct briefly and continue
          btnOk.disabled = true;
          const prev = questionText.textContent;
          questionText.textContent = `${prev} = ${q.ans}`;
          setTimeout(()=>{
            questionText.textContent = prev;
            qi++;
            nextQuestion();
          }, 600);
        }
      }

      correctCount.textContent = correct;
      wrongCount.textContent = wrong;
    }

    function awardCoins(n){
      if(n<=0) return;
      state.coins += n;
      saveState();
      updateTopbar();
    }

    function finishGame(passedAll){
      clearTimers();

      const total = questions.length;
      const isSpeed = selectedMode==="speed";

      let passed = false;
      if(isSpeed){
        // Must answer all correct within time; since we finish on fail, passedAll means success
        passed = passedAll && correct === total && wrong === 0 && qElapsed.length === total;
      }else{
        passed = false; // practice doesn't grant table clear
      }

      // streak logic: only speed-test can affect streak
      if(isSpeed){
        if(passed){
          state.streak += 1;
        }else{
          state.streak = 0;
        }
      }

      // Extra reward for passing speed test
      let coinGain = 0;
      if(isSpeed && passed){
        coinGain = 20;
        state.coins += coinGain;
      }

      // Update table progress on speed pass
      const p = state.progress[selectedTable];
      let newlyPassed = false;
      if(isSpeed && passed){
        if(!p.passed) newlyPassed = true;
        p.passed = true;

        // avg time
        const avg = qElapsed.reduce((a,b)=>a+b,0) / qElapsed.length;
        if(p.bestAvg == null || avg < p.bestAvg){
          p.bestAvg = avg;
          p.bestDate = nowISO();
        }
      }

      saveState();
      updateTopbar();
      renderHome();

      // Result screen
      showScreen("result");

      if(isSpeed){
        resultBig.textContent = passed ? "GODK√ÑND" : "EJ GODK√ÑND";
        resultBig.style.color = passed ? "var(--good)" : "var(--bad)";
        resultSub.textContent = passed
          ? `‚≠ê ${selectedTable}:an klar!`
          : (speedFailReason || "EJ GODK√ÑND");
      }else{
        resultBig.textContent = "KLART";
        resultBig.style.color = "var(--txt)";
        resultSub.textContent = "Tr√§ning";
      }

      statCorrect.textContent = `${correct}/${total}`;
      statWrong.textContent = `${wrong}`;
      statAvg.textContent = (isSpeed && qElapsed.length>0) ? `${fmt1(qElapsed.reduce((a,b)=>a+b,0)/qElapsed.length)}s` : "‚Äì";
      statCoins.textContent = `+${(isSpeed? (correct*2 + coinGain) : (correct*1))}`;

      lastResult = { table:selectedTable, mode:selectedMode };

      if(newlyPassed){
        popConfetti();
      }
    }

    let lastResult = { table:0, mode:"practice" };

    function popConfetti(){
      confetti.innerHTML = "";
      const count = 90;
      for(let i=0;i<count;i++){
        const p = document.createElement("i");
        const left = Math.random()*100;
        const delay = Math.random()*0.15;
        const r = Math.random()*360;
        const w = 6 + Math.random()*8;
        const h = 10 + Math.random()*10;

        p.style.left = left + "vw";
        p.style.animationDelay = delay + "s";
        p.style.setProperty("--r", r + "deg");
        p.style.width = w + "px";
        p.style.height = h + "px";
        // random light-ish colors
        const cols = ["rgba(77,163,255,.95)","rgba(46,204,113,.95)","rgba(255,176,32,.95)","rgba(255,77,77,.90)","rgba(179,107,255,.95)"];
        p.style.background = cols[Math.floor(Math.random()*cols.length)];

        confetti.appendChild(p);
      }
      confetti.classList.add("show");
      setTimeout(()=>confetti.classList.remove("show"), 1300);
    }

    // --------- Events ---------
    btnHome.addEventListener("click", ()=>{
      renderHome();
      showScreen("home");
    });
    btnAvatar.addEventListener("click", ()=>{
      showScreen("avatar");
      renderAvatarUI();
      applyAvatarPreview();
    });
    btnReset.addEventListener("click", ()=>{
      // single click reset, no extra text screens
      localStorage.removeItem(KEY);
      state = defaultState();
      saveState();
      init();
      showScreen("avatar");
    });

    btnSaveAvatar.addEventListener("click", ()=>{
      state.avatar.name = (inpName.value || "").trim().slice(0, 16);
      saveState();
      applyAvatarPreview();
      renderHome();
      showScreen("home");
    });

    inpName.addEventListener("input", ()=>{
      state.avatar.name = (inpName.value || "").trim().slice(0, 16);
      saveState();
      applyAvatarPreview();
    });

    btnBackFromMode.addEventListener("click", ()=>{
      renderHome();
      showScreen("home");
    });

    btnPractice.addEventListener("click", ()=> startGame("practice"));
    btnSpeed.addEventListener("click", ()=> startGame("speed"));

    btnQuitGame.addEventListener("click", ()=>{
      clearTimers();
      renderHome();
      showScreen("home");
    });

    btnOk.addEventListener("click", submitAnswer);
    answerInput.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        submitAnswer();
      }
      if(e.key === "Backspace") return;
      // keep digits only
      if(e.key.length===1 && !/[0-9]/.test(e.key)){
        e.preventDefault();
      }
    });
    answerInput.addEventListener("input", ()=>{
      answerInput.value = clampIntStr(answerInput.value);
    });

    document.querySelectorAll(".keypad .key").forEach(b=>{
      b.addEventListener("click", ()=>{
        const k = b.getAttribute("data-k");
        if(k==="del"){
          answerInput.value = answerInput.value.slice(0,-1);
          answerInput.focus({preventScroll:true});
          return;
        }
        if(k==="ok"){
          submitAnswer();
          return;
        }
        answerInput.value = clampIntStr(answerInput.value + k);
        answerInput.focus({preventScroll:true});
      });
    });

    btnToOverview.addEventListener("click", ()=>{
      renderHome();
      showScreen("home");
    });
    btnAgain.addEventListener("click", ()=>{
      startGame(lastResult.mode);
    });
    btnChangeMode.addEventListener("click", ()=>{
      showMode();
    });

    // --------- Init ---------
    function init(){
      updateTopbar();
      applyAvatarPreview();
      renderAvatarUI();
      renderHome();

      // First run: go avatar if no name set; otherwise home
      if((state.avatar.name || "").trim().length === 0){
        showScreen("avatar");
      }else{
        showScreen("home");
      }
    }

    init();
  </script>
</body>
</html>