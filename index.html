<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kl√§ julgranen ‚Äì t√§rningsspel</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#0b1320; color:#eaf2ff; }
    .wrap { max-width: 820px; margin: 0 auto; padding: 18px; }
    .card { background:#121d33; border:1px solid #223054; border-radius:14px; padding:16px; box-shadow: 0 10px 25px rgba(0,0,0,.25); }
    h1 { font-size: 20px; margin:0 0 10px; }
    h2 { font-size: 16px; margin:16px 0 8px; }
    p, li { line-height: 1.35; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .row > * { flex:1; min-width: 180px; }
    input, select, button {
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid #2a3a63;
      background: #0f1830;
      color: #eaf2ff;
      font-size: 16px;
      box-sizing: border-box;
    }
    button { cursor:pointer; background:#16305b; border-color:#2f4f8b; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .btn2 { background:#173a2a; border-color:#2b7a50; }
    .danger { background:#4a1520; border-color:#a33850; }
    .muted { color:#b9c8e6; font-size: 13px; }
    .big {
      font-size: 54px; text-align:center; padding: 10px 0; margin: 8px 0 2px;
      letter-spacing: 2px;
    }
    .pill {
      display:inline-block; padding:6px 10px; border-radius:999px;
      background:#0f1830; border:1px solid #2a3a63; color:#b9c8e6; font-size:13px;
    }
    .hr { height:1px; background:#223054; margin:14px 0; }
    .log { background:#0f1830; border:1px solid #223054; border-radius:12px; padding:12px; max-height: 180px; overflow:auto; }
    .log div { margin: 6px 0; }
    .hide { display:none !important; }
    .grid3 { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    .grid2 { display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="setupCard">
      <h1>üéÑ Kl√§ julgranen ‚Äì t√§rningsspel</h1>
      <p class="muted">1‚Äì5 spelare. Max 3 kulor per tur. Tappar du en kula: du st√•r √∂ver n√§sta tur.</p>

      <h2>Spelare</h2>
      <div class="row">
        <input id="p1" placeholder="Spelare 1 (obligatorisk)" />
        <input id="p2" placeholder="Spelare 2" />
      </div>
      <div class="row" style="margin-top:10px;">
        <input id="p3" placeholder="Spelare 3" />
        <input id="p4" placeholder="Spelare 4" />
      </div>
      <div class="row" style="margin-top:10px;">
        <input id="p5" placeholder="Spelare 5" />
        <div></div>
      </div>

      <div class="row" style="margin-top:14px;">
        <button id="startBtn" class="btn2">Starta spel</button>
        <button id="rulesBtn">Visa regler</button>
      </div>

      <div id="rulesBox" class="hide" style="margin-top:12px;">
        <div class="hr"></div>
        <ul>
          <li><b>1‚Äì3:</b> H√§ng samma antal kulor som t√§rningen visar.</li>
          <li><b>4 ‚Äì Julbyte:</b> Ge <b>1 kula</b> till valfri spelare som <b>m√•ste h√§nga den direkt</b>.</li>
          <li><b>5 ‚Äì Dubbelval:</b> V√§lj: <b>2 kulor sj√§lv</b> eller <b>tv√• olika spelare h√§nger 1 var</b>.</li>
          <li><b>6 ‚Äì Julchans:</b> V√§lj <b>exakt 1‚Äì3 kulor</b> att h√§nga.</li>
          <li><b>Tappad kula:</b> Turen avslutas direkt och du <b>st√•r √∂ver n√§sta tur</b>.</li>
        </ul>
      </div>
    </div>

    <div class="card hide" id="gameCard">
      <div class="row" style="align-items:center;">
        <div>
          <div class="pill" id="turnPill">Tur: ‚Äì</div>
          <div class="muted" style="margin-top:6px;">Tryck ‚ÄúKasta t√§rning‚Äù. F√∂lj instruktionen. Markera ‚ÄúKula tappad‚Äù om det h√§nder.</div>
        </div>
        <div style="min-width:220px; flex:0 0 220px;">
          <button id="resetBtn" class="danger">Nytt spel</button>
        </div>
      </div>

      <div class="big" id="diceFace">‚Äì</div>
      <div class="muted" style="text-align:center; margin-bottom:10px;">Senaste slag</div>

      <div class="row">
        <button id="rollBtn" class="btn2">üé≤ Kasta t√§rning</button>
        <button id="dropBtn" class="danger" disabled>‚ö†Ô∏è Kula tappad (st√• √∂ver n√§sta tur)</button>
      </div>

      <div class="hr"></div>

      <h2>Instruktion</h2>
      <div id="instruction" class="log"></div>

      <!-- Special UI -->
      <div id="specialArea" class="hide" style="margin-top:12px;">
        <div class="hr"></div>
        <h2>Val kr√§vs</h2>

        <!-- For 4 -->
        <div id="special4" class="hide">
          <p><b>4 ‚Äì Julbyte:</b> V√§lj vem som ska h√§nga 1 kula direkt.</p>
          <select id="s4Target"></select>
          <div style="margin-top:10px;">
            <button id="s4Confirm" class="btn2">Bekr√§fta</button>
          </div>
        </div>

        <!-- For 5 -->
        <div id="special5" class="hide">
          <p><b>5 ‚Äì Dubbelval:</b> V√§lj alternativ.</p>
          <div class="grid2">
            <button id="s5Self">Jag h√§nger 2 kulor</button>
            <button id="s5TwoPlayers">Tv√• spelare h√§nger 1 var</button>
          </div>

          <div id="s5PickTwo" class="hide" style="margin-top:12px;">
            <p>V√§lj tv√• olika spelare:</p>
            <div class="row">
              <select id="s5A"></select>
              <select id="s5B"></select>
            </div>
            <div style="margin-top:10px;">
              <button id="s5Confirm" class="btn2">Bekr√§fta</button>
            </div>
            <p class="muted">Tips: V√§lj inte samma spelare i b√•da listorna.</p>
          </div>
        </div>

        <!-- For 6 -->
        <div id="special6" class="hide">
          <p><b>6 ‚Äì Julchans:</b> V√§lj exakt antal kulor att h√§nga (1‚Äì3).</p>
          <div class="grid3">
            <button class="s6Btn" data-n="1">H√§ng 1</button>
            <button class="s6Btn" data-n="2">H√§ng 2</button>
            <button class="s6Btn" data-n="3">H√§ng 3</button>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <h2>Turordning</h2>
      <div id="playersLine" class="muted"></div>

      <h2>Logg</h2>
      <div class="log" id="logBox"></div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const setupCard = $("setupCard");
  const gameCard  = $("gameCard");

  const startBtn = $("startBtn");
  const rulesBtn = $("rulesBtn");
  const rulesBox = $("rulesBox");

  const turnPill = $("turnPill");
  const diceFace = $("diceFace");
  const rollBtn  = $("rollBtn");
  const dropBtn  = $("dropBtn");
  const resetBtn = $("resetBtn");

  const instruction = $("instruction");
  const logBox = $("logBox");
  const playersLine = $("playersLine");

  const specialArea = $("specialArea");
  const special4 = $("special4");
  const special5 = $("special5");
  const special6 = $("special6");

  const s4Target = $("s4Target");
  const s4Confirm = $("s4Confirm");

  const s5Self = $("s5Self");
  const s5TwoPlayers = $("s5TwoPlayers");
  const s5PickTwo = $("s5PickTwo");
  const s5A = $("s5A");
  const s5B = $("s5B");
  const s5Confirm = $("s5Confirm");

  const state = {
    players: [],
    idx: 0,
    skipNext: {}, // name -> boolean
    canDrop: false,
    pending: null, // {dice: number, roller: name}
    awaitingChoice: false
  };

  function sanitizeName(s) {
    return (s || "").trim().replace(/\s+/g, " ");
  }

  function log(msg) {
    const d = document.createElement("div");
    d.textContent = msg;
    logBox.prepend(d);
  }

  function setInstruction(htmlText) {
    instruction.innerHTML = `<div>${htmlText}</div>`;
  }

  function showSpecial(n) {
    specialArea.classList.remove("hide");
    special4.classList.toggle("hide", n !== 4);
    special5.classList.toggle("hide", n !== 5);
    special6.classList.toggle("hide", n !== 6);
  }

  function hideSpecial() {
    specialArea.classList.add("hide");
    special4.classList.add("hide");
    special5.classList.add("hide");
    special6.classList.add("hide");
    s5PickTwo.classList.add("hide");
  }

  function currentPlayer() {
    return state.players[state.idx];
  }

  function rebuildPlayerLine() {
    const parts = state.players.map((p, i) => {
      const skip = state.skipNext[p] ? " (st√•r √∂ver n√§sta)" : "";
      const marker = i === state.idx ? " üëâ" : "";
      return `${p}${skip}${marker}`;
    });
    playersLine.textContent = parts.join("  ‚Ä¢  ");
  }

  function nextTurn(autoNote) {
    // move to next player, respecting skipNext
    let safety = 0;
    do {
      state.idx = (state.idx + 1) % state.players.length;
      safety++;
      if (safety > 20) break;
      const p = currentPlayer();
      if (state.skipNext[p]) {
        state.skipNext[p] = false;
        log(`‚è≠Ô∏è ${p} st√•r √∂ver sin tur.`);
        // continue to next
      } else {
        break;
      }
    } while (true);

    state.pending = null;
    state.awaitingChoice = false;
    state.canDrop = false;
    dropBtn.disabled = true;
    rollBtn.disabled = false;
    diceFace.textContent = "‚Äì";
    hideSpecial();

    turnPill.textContent = `Tur: ${currentPlayer()}`;
    rebuildPlayerLine();
    if (autoNote) setInstruction(autoNote);
  }

  function startGame() {
    const names = [$("p1").value, $("p2").value, $("p3").value, $("p4").value, $("p5").value]
      .map(sanitizeName)
      .filter(Boolean);

    // unique, preserve order
    const uniq = [];
    for (const n of names) if (!uniq.includes(n)) uniq.push(n);

    if (uniq.length < 1) {
      alert("Ange minst 1 spelare (Spelare 1).");
      return;
    }

    state.players = uniq.slice(0, 5);
    state.idx = 0;
    state.skipNext = {};
    state.pending = null;
    state.awaitingChoice = false;
    state.canDrop = false;

    setupCard.classList.add("hide");
    gameCard.classList.remove("hide");

    logBox.innerHTML = "";
    setInstruction("Tryck <b>üé≤ Kasta t√§rning</b>.");
    turnPill.textContent = `Tur: ${currentPlayer()}`;
    rebuildPlayerLine();
    log(`‚úÖ Spelet startade. Spelare: ${state.players.join(", ")}.`);
  }

  function fillSelect(sel, includeSelf = true, exclude = []) {
    sel.innerHTML = "";
    const roller = currentPlayer();
    for (const p of state.players) {
      if (!includeSelf && p === roller) continue;
      if (exclude.includes(p)) continue;
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      sel.appendChild(opt);
    }
  }

  function rollDice() {
    const roller = currentPlayer();
    const dice = Math.floor(Math.random() * 6) + 1;
    state.pending = { dice, roller };
    state.canDrop = true;
    dropBtn.disabled = false;
    rollBtn.disabled = true;

    diceFace.textContent = String(dice);
    log(`üé≤ ${roller} slog ${dice}.`);

    if (dice >= 1 && dice <= 3) {
      setInstruction(`<b>${roller}</b>: H√§ng <b>${dice}</b> kula/kulor. (Max 3)`);
      state.awaitingChoice = false;
      // Efter att de h√§ngt klart trycker de bara "Kasta t√§rning" igen? Vi k√∂r auto n√§sta tur via knapp:
      // Vi g√∂r det enkelt: tryck p√• Kasta t√§rning f√∂r n√§sta tur f√∂rst efter att man √§r klar.
      // Men f√∂r att undvika dubbel-slag: l√§gg till en "N√§sta spelare"-upplevelse via instruktionen.
      setInstruction(`<b>${roller}</b>: H√§ng <b>${dice}</b> kula/kulor. N√§r du √§r klar: tryck <b>üé≤ Kasta t√§rning</b> f√∂r att g√• vidare.`);
      // F√∂r att g√• vidare m√•ste vi till√•ta "Kasta t√§rning" -> men d√• sl√•r n√§sta direkt. B√§ttre: automatisk turv√§xling via "Klar"-knapp.
      // Vi skapar en snabb "Klar"-knapp inline:
      instruction.innerHTML = `
        <div><b>${roller}</b>: H√§ng <b>${dice}</b> kula/kulor. (Max 3)</div>
        <div style="margin-top:10px;">
          <button id="doneBtn" class="btn2">‚úÖ Klar ‚Äì n√§sta spelare</button>
        </div>
      `;
      $("doneBtn").onclick = () => nextTurn(`Tryck <b>üé≤ Kasta t√§rning</b>.`);
      return;
    }

    // Specials 4-6
    state.awaitingChoice = true;
    showSpecial(dice);

    if (dice === 4) {
      fillSelect(s4Target, true);
      setInstruction(`<b>4 ‚Äì Julbyte</b>: V√§lj vem som ska h√§nga <b>1</b> kula direkt.`);
    } else if (dice === 5) {
      s5PickTwo.classList.add("hide");
      setInstruction(`<b>5 ‚Äì Dubbelval</b>: V√§lj alternativ.`);
    } else if (dice === 6) {
      setInstruction(`<b>6 ‚Äì Julchans</b>: V√§lj exakt <b>1‚Äì3</b> kulor att h√§nga.`);
    }
  }

  function markDropped() {
    if (!state.canDrop) return;
    const p = currentPlayer();
    state.skipNext[p] = true;
    state.canDrop = false;
    dropBtn.disabled = true;
    hideSpecial();

    log(`‚ö†Ô∏è ${p} tappade en kula och st√•r √∂ver n√§sta tur.`);
    // Turen avslutas direkt
    nextTurn(`‚ö†Ô∏è ${p} tappade en kula. N√§sta spelare: tryck <b>üé≤ Kasta t√§rning</b>.`);
  }

  // Special handlers
  s4Confirm.onclick = () => {
    const roller = currentPlayer();
    const target = s4Target.value;
    log(`üéÅ 4 ‚Äì ${roller} gav 1 kula till ${target} som h√§nger den direkt.`);
    setInstruction(`<b>${target}</b>: H√§ng <b>1</b> kula direkt. N√§r klart: tryck <b>‚úÖ Klar</b>.`);
    instruction.innerHTML = `
      <div><b>${target}</b>: H√§ng <b>1</b> kula direkt.</div>
      <div style="margin-top:10px;">
        <button id="doneBtn" class="btn2">‚úÖ Klar ‚Äì n√§sta spelare</button>
      </div>
    `;
    $("doneBtn").onclick = () => nextTurn(`Tryck <b>üé≤ Kasta t√§rning</b>.`);
    state.awaitingChoice = false;
    state.canDrop = true; // fortfarande tapp-regel g√§ller under special-utf√∂rande
    hideSpecial();
  };

  s5Self.onclick = () => {
    const roller = currentPlayer();
    log(`‚ú® 5 ‚Äì ${roller} valde att h√§nga 2 kulor.`);
    instruction.innerHTML = `
      <div><b>${roller}</b>: H√§ng <b>2</b> kulor. (Max 3)</div>
      <div style="margin-top:10px;">
        <button id="doneBtn" class="btn2">‚úÖ Klar ‚Äì n√§sta spelare</button>
      </div>
    `;
    $("doneBtn").onclick = () => nextTurn(`Tryck <b>üé≤ Kasta t√§rning</b>.`);
    hideSpecial();
    state.awaitingChoice = false;
  };

  s5TwoPlayers.onclick = () => {
    s5PickTwo.classList.remove("hide");
    fillSelect(s5A, true);
    fillSelect(s5B, true);
  };

  s5Confirm.onclick = () => {
    const roller = currentPlayer();
    const a = s5A.value;
    const b = s5B.value;
    if (a === b) {
      alert("V√§lj tv√• olika spelare.");
      return;
    }
    log(`‚ú® 5 ‚Äì ${roller} valde att ${a} och ${b} h√§nger 1 kula var.`);
    instruction.innerHTML = `
      <div><b>${a}</b> och <b>${b}</b>: H√§ng <b>1</b> kula var (totalt 2).</div>
      <div style="margin-top:10px;">
        <button id="doneBtn" class="btn2">‚úÖ Klar ‚Äì n√§sta spelare</button>
      </div>
    `;
    $("doneBtn").onclick = () => nextTurn(`Tryck <b>üé≤ Kasta t√§rning</b>.`);
    hideSpecial();
    state.awaitingChoice = false;
  };

  document.querySelectorAll(".s6Btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const n = Number(btn.dataset.n);
      const roller = currentPlayer();
      log(`üåü 6 ‚Äì ${roller} valde att h√§nga ${n} kula/kulor.`);
      instruction.innerHTML = `
        <div><b>${roller}</b>: H√§ng <b>${n}</b> kula/kulor. (Max 3)</div>
        <div style="margin-top:10px;">
          <button id="doneBtn" class="btn2">‚úÖ Klar ‚Äì n√§sta spelare</button>
        </div>
      `;
      $("doneBtn").onclick = () => nextTurn(`Tryck <b>üé≤ Kasta t√§rning</b>.`);
      hideSpecial();
      state.awaitingChoice = false;
    });
  });

  // Buttons
  startBtn.onclick = startGame;
  rollBtn.onclick = () => {
    // Om spelaren inte har gjort "Klar" kan de √§nd√• trycka. Vi till√•ter bara om inte pending/awaitingChoice.
    if (state.pending || state.awaitingChoice) return;
    rollDice();
  };
  dropBtn.onclick = markDropped;

  resetBtn.onclick = () => {
    if (!confirm("Starta om och ange spelare igen?")) return;
    gameCard.classList.add("hide");
    setupCard.classList.remove("hide");
    rulesBox.classList.add("hide");
    $("p1").focus();
  };

  rulesBtn.onclick = () => rulesBox.classList.toggle("hide");

  // Init
  $("p1").focus();
})();
</script>
</body>
</html>